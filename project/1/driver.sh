# nuke that shit
input_file="inputs"
rm $input_file
touch $input_file

payloadState=0
binary="/levels/project1/tw33tchainz"
stepsSinceExit=999

# program state constants
programState=0
GET_PASS=1000
GET_ADMIN=1001

tail -f $input_file | $binary | while read output
do
    # filter the asni colors and clears
    output="$(echo "$output" | sed "s,\x1B\[[0-9;]*[a-zA-Z],,g")"
    echo "$output"

    case "$programState" in
        $GET_PASS)
            genpass="$output"
            password="$(python decode_pass.py $genpass)"
            programState=$GET_ADMIN
        ;;
        $GET_ADMIN)
            if [ "$stepsSinceExit" == "1" ]
            then
                sleep 1
                printf "3\n" >> $input_file
                sleep 1
                printf "$password\n" >> $input_file
                programState=4
            fi
        ;;
        *)
            #Do nothing
        ;;
    esac

    case "$output" in
        "Enter Username:")
            input="$(python -c "print '\x01'*15")"
        ;;
        "Enter Salt:")
            input="$(python -c "print '\xff'*15")"
        ;;
        "Generated Password:")
            programState=$GET_PASS
            input="\n"
        ;;
        "5: Exit"*)
            stepsSinceExit=0
        ;;
        *)
            #Do nothing
        ;;
    esac

    stepsSinceExit=$(($stepsSinceExit + 1))


    case "$input" in
        "")
            # nothing happens, this is the waiting state.
        ;;
        *)
            # any real input
            printf "$input" >> $input_file
            input=""
        ;;
    esac

done
